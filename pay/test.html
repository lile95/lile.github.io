<!DOCTYPE html>
<html lang="pay">
<head>
    <meta charset="utf-8" />
    <!--<meta name="viewport" content="user-scalable=no">
    <meta name="x5-page-mode" content="app"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="-webkit-linear-gradient( right,#40a1ff,#29c4fc)"/>
    <meta name="viewport" content="user-scalable=no,width=980, initial-scale=1">-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, minimal-ui">
    <title>向商家付款</title>
    <link rel="stylesheet" href="css/test.css">
    <script src="js/jQuery.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/index.js"></script>
    <script src="js/vconsole.min.js" type="text/javascript" charset="utf-8"></script>
    <script>
        // 初始化
        let vConsole = new VConsole();
        (function (doc, win) {
            const docEl = doc.documentElement,
                resizeEvt = 'onorientationchange' in window ? 'onorientationchange' : 'resize',
                recalc = function () {
                    const clientWidth = docEl.clientWidth;
                    if (!clientWidth) return;
                    if (clientWidth >= 750) {
                        docEl.style.fontSize = '100px';
                    } else {
                        docEl.style.fontSize = 100 * (clientWidth / 750) + 'px';
                    }
                };

            if (!doc.addEventListener) return;
            win.addEventListener(resizeEvt, recalc, false);
            doc.addEventListener('DOMContentLoaded', recalc, false);
        })(document, window);
    </script>
</head>
<body>
<div id="jx_pay">
    <div class="content">
        <!--<header>
            <div class="left_head">
                <span class="back_border"></span>
                <p class="title">返回</p>
            </div>
            <p class="title_content">向商户付款</p>
        </header>-->
        <div class="shop_row">
            <div class="svg_parent" >
                <div class="logo" style=" background-repeat: no-repeat; background-image: url(svg/shop1.svg); background-size: 100% 100%;"></div>
            </div>
            <div class="shop_name">
                <h2> <span class="left_name" id="shopName"></span> <!--<span class="right_name">&lt;!&ndash;添加备注&ndash;&gt;</span>--></h2>
                <div class="store">
                    <span class="store_name">门店</span>
                    <span class="store_content"></span>
                </div>
            </div>
        </div>
        <!--输入金额-->
        <div class="import_box">
            <div class="import_content">
                <span class="money">消费金额</span>
                <div class="inputs">
                    <span class="rnb">￥</span>
                    <span id="money" class="import_pay"></span>
                    <i class="cursor"></i>
                </div>
            </div>
        </div>
        <!--按键-->
        <div class="key">
            <div>
                <div class="key_row">
                    <span onclick="return btnNum_onclick(1,this)">1</span>
                    <span onclick="return btnNum_onclick(2,this)">2</span>
                    <span onclick="return btnNum_onclick(3,this)">3</span>
                    <span onclick="return delText(this)">
								<i class="delete" style=" background-repeat: no-repeat;
														  background-image: url(svg/delete.svg);
														  background-size: 100% 100%;">
								</i>
							</span>
                </div>
                <div class="separate">
                    <div class="right_separate">
                        <div class="key_row">
                            <span onclick="return btnNum_onclick(4,this)">4</span>
                            <span onclick="return btnNum_onclick(5,this)">5</span>
                            <span onclick="return btnNum_onclick(6,this)">6</span>
                        </div>
                        <div class="key_row">
                            <span onclick="return btnNum_onclick(7,this)">7</span>
                            <span onclick="return btnNum_onclick(8,this)">8</span>
                            <span onclick="return btnNum_onclick(9,this)">9</span>
                        </div>
                        <div class="key_row">
                            <span onclick="return btnNum_onclick(0,this)" style="flex: 2;">0</span>
                            <span onclick="return btnNum_onclick('.',this)">.</span>
                        </div>
                    </div>
                    <div class="left_separate"  id="separate">
								<span class="notarize">
									确认支付
								</span>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>
<!--suppress JSUnresolvedVariable, EqualityComparisonWithCoercionJS, JSValidateTypes -->
<script>

    let allUrl = 'http://dev.pay.jiangxinit.com/api/pay' ;
    //             let allUrl = 'http://192.168.0.11:8088/api/pay' ;
    let wxUrl = 'http://wx.jiangxinit.com/api' ;
    let typePay = '';
    let openId = '' ;
    let unique = {};
    let appId = '' ;
    let url = window.location.search; //获取url中"?"符后的字串
    /**
     * @return {boolean}
     */
    function IsWeixinOrAlipay(){
        let ua = window.navigator.userAgent.toLowerCase();
        //判断是不是微信
        if ( ua.match(/MicroMessenger/i) == 'micromessenger' ) {
            // return "WeiXIN";
            typePay = 'wxpay';
            function onBridgeReady(){   // 隐藏微信右上角功能
                WeixinJSBridge.call('hideOptionMenu');
            }
            if (typeof WeixinJSBridge == "undefined"){
                if( document.addEventListener ){
                    document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
                }else if (document.attachEvent){
                    document.attachEvent('WeixinJSBridgeReady', onBridgeReady);
                    document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
                }
            }else{
                onBridgeReady();
            }

            /*if (GetQueryString('code')) {    //判断是否有参数
                let str = url.substr(1); //从第一个字符开始 因为第0个是?号 获取所有除问号的所有符串
                let  strs = str.split("&");   //用等号进行分隔 （因为知道只有一个参数 所以直接用等号进分隔 如果有多个参数 要用&号分隔 再用等号进行分隔）
                // dialog(strs[1]);          //直接弹出第一个参数 （如果有多个参数 还要进行循环的）
                strs.forEach((item)=>{
                    let sp1 = item.split("=")[0];
                    unique[sp1] = item.split("=")[1]
                });
                console.log(unique.code);
                if (unique.code){
                    GetRequest();
                }
            }else {
                $("#pos").hide();
                getUrl();
            }*/

            if (!GetQueryString('openid')) {
                getOpenid()
            }
            /**微信支付
             * w*/
            $('#separate').on('click',function() {
                let money = document.getElementById("money").innerHTML;
                let date = Date.parse(new Date())+'';
                let data = {
                    "money":Number(money),
                    "mchnt_cd":GetQueryString('mchntcd'),
                    "type":typePay,
                    "name":GetQueryString('sid')?'KS'+GetQueryString('sid')+'-'+date.substr(date.length - 7):'向商家付款',   //todo
                    "openId":openId,
                    "appId":appId,
                    "sid":GetQueryString('sid')?GetQueryString('sid'):null
                };
                $.ajax({
                    type: 'POST',
                    contentType:'application/json',
                    url: allUrl+"/receiptcode",
                    data: JSON.stringify(data),
                    xhrFields: {
                        withCredentials: true    // 前端设置是否带cookie
                    },
                    crossDomain: true,   // 会让请求头中包含跨域的额外信息，但不会含cookie
                    success: function(res){
                        console.log(res);
                        function onBridgeReady(){
                            WeixinJSBridge.invoke(
                                'getBrandWCPayRequest', {
                                    "appId":res.data.sdk_appid,     //公众号名称，由商户传入
                                    "timeStamp":res.data.sdk_timestamp,         //时间戳，自1970年以来的秒数
                                    "nonceStr":res.data.sdk_noncestr, //随机串
                                    "package":res.data.sdk_package,
                                    "signType":res.data.sdk_signtype,         //微信签名方式：
                                    "paySign":res.data.sdk_paysign //微信签名
                                },
                                function(res){
                                    // _this.wxtext = res;
                                    if(res.err_msg === "get_brand_wcpay_request:ok" ){
                                        window.location.href = 'paySuccess.html?money='+money
                                        // dialog(res.err_msg);
                                        // 使用以上方式判断前端返回,微信团队郑重提示：
                                        //res.err_msg将在用户支付成功后返回ok，但并不保证它绝对可靠。
                                    }else{
                                        // dialog(res.err_desc)
                                    }
                                });
                        }
                        if (typeof WeixinJSBridge == "undefined"){
                            if( document.addEventListener ){
                                document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
                            }else if (document.attachEvent){
                                document.attachEvent('WeixinJSBridgeReady', onBridgeReady);
                                document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
                            }
                        }else{
                            onBridgeReady();
                        }

                    }});
            });

        }else
        /**
         * 判断是不是支付宝
         * */
        if (ua.match(/AlipayClient/i) == 'alipayclient') {
            typePay = 'alipay';
            AlipayJSBridge.call('setTitle', {
                title: '向商家付款',
            });
            AlipayJSBridge.call("setTitleColor", {
                color: 3128310,
                reset: false //(可选,默认为false)  是否重置title颜色为默认颜色。
            });
            function ready(callback) {
                // 如果jsbridge已经注入则直接调用
                if (window.AlipayJSBridge) {
                    callback && callback();
                } else {
                    // 如果没有注入则监听注入的事件
                    document.addEventListener('AlipayJSBridgeReady', callback, false);
                }
            }
            ready(function() {
                AlipayJSBridge.call('setOptionMenu', {
                    title : ' ',
                    redDot : '-1', // -1表示不显示，0表示显示红点，1-99表示在红点上显示的数字
                    color : '#ffff6600', // 必须以＃开始ARGB颜色值
                });

                document.addEventListener('optionMenu', function(e) {
                }, false);
            });
            /**
             * 支付宝支付
             **/
            $('#separate').on('click',function() {
                console.log('支付宝');
                let money = document.getElementById("money").innerHTML;
                let date = Date.parse(new Date())+'';

                let data = {
                    "money":Number(money),
                    "mchnt_cd":GetQueryString('mchntcd'),
                    "type":'alipay',
                    "name":GetQueryString('sid')?'KS'+GetQueryString('sid')+'-'+date.substr(date.length - 7):'向商家付款',
                    "sid":GetQueryString('sid')?GetQueryString('sid'):null
                };
                console.log(data)
                $.ajax({
                    type: 'POST',
                    contentType:'application/json',
                    url: allUrl+"/receiptcode",
                    // url:"http://192.168.0.16:8088/api/pay/receiptcode",
                    data: JSON.stringify(data),
                    xhrFields: {
                        withCredentials: true    // 前端设置是否带cookie
                    },
                    crossDomain: true,   // 会让请求头中包含跨域的额外信息，但不会含cookie
                    success: function(res){
                        console.log(res);
                        window.location.replace(res.data.qr_code)
                    }});
            });

        }
        /* if (ua.match(/AlipayClient/i) == 'alipayclient' ||ua.match(/MicroMessenger/i) == 'micromessenger') {

         }else{
             location.replace('http://404')
         }*/ //todo

    }
    IsWeixinOrAlipay();

    /*function getUrl (){   // 获取重定向地址
        let data = {
            "type":0,
            "account":GetQueryString('account'),
            "url":"http://web.jiangxinit.com/pay.html",   //todo
            "mchntCd":GetQueryString('mchntcd'),
            "sid":GetQueryString('sid')?GetQueryString('sid'):null,
        };
        $.ajax({
            type: 'POST',
            contentType:'application/json',
            url:wxUrl+"/oAuthUrl",
            data: JSON.stringify(data),
            success: function(res){
                window.location.href = res.data.url
            }});
    }*/
    getShop() ;
    function getShop() {  //获取店铺名字
        let  data = {
            "mchntCd":GetQueryString('mchntcd'),
            "sid":GetQueryString('sid')?GetQueryString('sid'):null
        }
        $.ajax({
            type:"POST",
            url:allUrl+"/greceipt",
            contentType:'application/json',
            data:JSON.stringify(data),
            success: function(res){
                $('#shopName').html(res.data.shortName)
                $('.store_content').html(res.data.shopName)
            }
        })
    }
    /*function GetRequest() {  //获取openid
        let data = {
            "code":unique.code,
            "account":unique.state
        } ;
        $.ajax({
            type:"POST",
            url:wxUrl+"/oAuthOpenId",
            contentType:'application/json',
            data:JSON.stringify(data),
            success: function(res){
                openId = res.data.openid ;
                appId = res.data.appid ;
            }
        })
    }*/
    /**
     * 获取openid
     * */
    if (GetQueryString('openid')) {
        openId = GetQueryString('openid');
        appId = GetQueryString('appid')
    }
    function getOpenid() {
        let data = {
            "url":"http://dev.web.jiangxinit.com/test.html",  //todo
            "mchntCd":GetQueryString('mchntcd') ,  //"0002900F0370588",
            // "tradeno":GetQueryString('tradeno'),
            "sid":GetQueryString('sid'),
        };
        $.ajax({
            type: 'POST',
            contentType:'application/json',
            url:allUrl+"/oAuthOpenIdByFuiou",
            data: JSON.stringify(data),
            success: function(res){
                location.replace(res.data)
            }});
    }



    /**
     * @return {string}
     */
    function GetQueryString(name) {   //获取url  的参数
        let reg = new RegExp("(^|&)"+ name +"=([^&]*)(&|$)");
        let r = window.location.search.substr(1).match(reg);//search,查询？后面的参数，并匹配正则
        if(r!=null)return  unescape(r[2]); return null;
    }
    
    (function rotate(){
   var orientation=window.orientation;
   var pd = null;
   function createPd(){
       if(document.getElementById('preventTran') === null){
            var imgData = 'data:image/png;base64,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';
            pd = document.createElement('div');
            pd.setAttribute('id','preventTran');
            pd.style.position = 'fixed';
            pd.style.left = '0';
            pd.style.top = '0';
            pd.style.width = '100%';
            pd.style.height = '100%';
            pd.style.overflow = 'hidden';
            pd.style.backgroundColor = '#2e2e2e';
            pd.style.textAlign = 'center';
            pd.style.zIndex = '99999';
            document.getElementsByTagName('body')[0].appendChild(pd);
            var img = document.createElement('img');
            img.src = imgData;
            pd.appendChild(img);
            img.style.margin = '60px auto 30px'
            var br = document.createElement('br');
            var p = document.createElement('p');
            p.style.width = '100%';
            p.style.height = 'auto';
            p.style.fontSize = '22px';
            p.style.color = '#626262';
            p.style.lineHeight = '34px';
            p.style.textAlign = 'center';
            p.innerHTML = '为了您的良好体验';
            p.appendChild(br);
            p.innerHTML += '请将手机/平板竖屏操作';
            pd.appendChild(p);
        }
   }
   if(orientation==90||orientation==-90){
        if(pd == null && document.getElementById('preventTran') === null) createPd();
        document.getElementById('preventTran').style.display = 'block';
   }
   window.onorientationchange=function(){
      if(pd == null && document.getElementById('preventTran') == null) createPd();
      document.getElementById('preventTran').style.display='none';
      rotate();
   };
})();
</script>
<!--<script src="js/Dialog.js"></script>-->
</body>
</html>
